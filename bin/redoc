#!/usr/bin/env node

const path = require('path')
const amf = require('amf-client-js')

const { postProcess } = require("./lib/post-processing")

function normalizeSecuritySchemes(spec) {
  spec = JSON.parse(spec)

  var bearer = spec["components"]["x-amf-securitySchemes"]["bearer"]
  delete spec["components"]["x-amf-securitySchemes"]

  bearer["type"] = "http"
  bearer["scheme"] = "bearer"
  bearer["bearerFormat"] = bearer["x-amf-describedBy"].headers.Authorization.pattern.replace("Bearer ", "^") + "$"
  delete bearer["x-amf-describedBy"]

  spec.components.securitySchemes.bearer = bearer

  return JSON.stringify(spec)
}

function deepRemoveAnnotations(obj, predicate) {
  Object.entries(obj).forEach(([prop, val]) => {
    if (predicate(prop)) {
      delete obj[prop]
    } else if (val && typeof val == "object") {
      deepRemoveAnnotations(val, predicate)
    }
  });
}

function deepNormalizeSecurity(obj) {
  Object.entries(obj).forEach(([_prop, val]) => {
    if (val && typeof val == "object") {
      if (val.hasOwnProperty("x-amf-security")) {
        val.security = val.security.concat(val["x-amf-security"])
        delete val["x-amf-security"]
      }

      deepNormalizeSecurity(val)
    }
  })
}

function removeAnnotations(spec) {
  spec = JSON.parse(spec)

  const annotations = [
    "x-amf-uses",
    "x-amf-is",
    "x-amf-type",
    "x-common",
    "x-prelude.common",
  ]

  deepRemoveAnnotations(spec, (prop) =>
    prop.startsWith("x-specs.") || annotations.includes(prop)
  )
  deepNormalizeSecurity(spec)

  return JSON.stringify(spec)
}

function normalizeLogo(spec) {
  spec = JSON.parse(spec)

  let logo = spec["x-core.logo"]

  if (logo) {
    delete spec["x-core.logo"]
    spec.info["x-logo"] = logo
  }

  return JSON.stringify(spec)
}

function redoc(spec) {
  spec = normalizeLogo(removeAnnotations(normalizeSecuritySchemes(spec)))
    .replace(/x-amf-union/g, "anyOf")
    .replace(/x-core\.tags/g, "tags")
    .replace(/x-core\.tagGroups/g, "x-tagGroups")
    .replace(/x-core\.expandable/g, "x-expandable")
    .replace(/("x-expandable":)null/g, "$1true")
    .replace(/x-prelude\.discriminatorJunction/g, "discriminator")
    .replace(/,"anyOf":\[{"\$ref":"[^"]+"}]/g, "")
    // FIXME: the following shouldn't be necessary, but something causes the
    // wrong $ref in usages of the Events union.
    .replace(/"\$ref":"#\/definitions\/([^"]+)"/g, '"$ref":"#/components/schemas/$1"')
    .replace(/#\/definitions\//g, "")

  return `<!DOCTYPE html>
<html>
<head>
  <title>Hund API v1 Documentation</title>
  <meta name="description" content="View documentation for the Hund API v1.">

  <link rel="icon" href="https://hund.io/favicon.ico">

  <script src="https://cdn.jsdelivr.net/npm/redoc@2.0.0-rc.72/bundles/redoc.standalone.js"> </script>

  <style>
    strong code {
      font-weight: bold !important;
    }

    h4 code {
      font-size: 14px !important;
      font-weight: bold !important;
    }

    label[role=menuitem] {
        padding-top: 5px;
        padding-bottom: 5px;
    }
  </style>
</head>

<body>
  <div id="redoc-container"></div>

  <script>
    const spec = ${spec};
    Redoc.init(spec, {jsonSampleExpandLevel: 3, expandResponses: "200,201", showExtensions: ["x-expandable"], hideSingleRequestSampleTab: true, requiredPropsFirst: true, sortPropsAlphabetically: false, theme: {logo: {gutter: "1rem"}}}, document.getElementById("redoc-container"))
  </script>
</body>
</html>`
}

const ramlPath = process.argv[2]

async function main () {
  const ramlDir = path.resolve(ramlPath)
  const raml10 = amf.RAMLConfiguration.RAML10().baseUnitClient();
  const oas30 = amf.OASConfiguration.OAS30().baseUnitClient();

  const parseResult = await raml10.parse(`file://${ramlDir}`)
  const resolved = raml10.transform(parseResult.baseUnit, amf.PipelineId.Cache)

  postProcess(resolved.baseUnit)

  const spec = oas30.render(resolved.baseUnit, "application/json")

  console.log(redoc(spec))
}

main()
